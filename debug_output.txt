============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /root/workspace/emailops-vertex-ai
configfile: pytest.ini
plugins: anyio-4.12.0, mock-3.15.1, xdist-3.8.0, langsmith-0.5.0, timeout-2.4.0, cov-7.0.0, asyncio-1.3.0
timeout: 300.0s
timeout method: signal
timeout func_only: False
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 7 items / 6 deselected / 1 selected

cli/tests/test_main_refactored.py::TestCliMainUtils::test_run_search_success FAILED [100%]/usr/local/lib/python3.10/dist-packages/coverage/inorout.py:521: CoverageWarning: Module cortex was never imported. (module-not-imported); see https://coverage.readthedocs.io/en/7.13.0/messages.html#warning-module-not-imported
  self.warn(f"Module {pkg} was never imported.", slug="module-not-imported")


=================================== FAILURES ===================================
___________________ TestCliMainUtils.test_run_search_success ___________________

query = 'query', top_k = 10, tenant_id = 'default', json_output = False

    def _run_search(
        query: str,
        top_k: int = 10,
        tenant_id: str = "default",
        json_output: bool = False,
    ) -> None:
        """
        Search indexed emails with natural language queries.
        """
        import json
    
        if not json_output:
            _print_banner()
            print(f"{_colorize('▶ SEARCH', 'bold')}\n")
            print(f"  Query:   {_colorize(query, 'cyan')}")
            print(f"  Top K:   {_colorize(str(top_k), 'dim')}")
            print()
    
        try:
            from cortex.retrieval.hybrid_search import (
                KBSearchInput as _KBSearchInput,  # type: ignore[import]
            )
            from cortex.retrieval.hybrid_search import (
                tool_kb_search_hybrid as _tool_kb_search_hybrid,  # type: ignore[import]; type: ignore[reportUnknownVariableType]
            )
    
            _KBSearchInput = cast(Any, _KBSearchInput)
            _tool_kb_search_hybrid = cast(Any, _tool_kb_search_hybrid)
            KBSearchInput: type[Any] = cast(type[Any], _KBSearchInput)
            tool_kb_search_hybrid: Callable[[Any], Any] = cast(
                Callable[[Any], Any], _tool_kb_search_hybrid
            )
    
            request: Any = KBSearchInput(
                tenant_id=tenant_id,
                user_id="cli-user",
                query=query,
                k=top_k,
            )
    
            if not json_output:
                print(f"  {_colorize('⏳', 'yellow')} Searching...\n")
    
            results: Any = tool_kb_search_hybrid(request)
    
            if json_output:
                # Convert results to JSON-serializable format
                output: dict[str, Any] = {
                    "success": True,
                    "query": query,
                    "results": (
                        [r.model_dump() for r in results.results]
                        if hasattr(results, "results")
                        else []
                    ),
                    "total": len(results.results) if hasattr(results, "results") else 0,
                }
                print(json.dumps(output, indent=2, default=str))
            else:
                if hasattr(results, "results") and results.results:
                    print(
                        f"  {_colorize('✓', 'green')} Found {len(results.results)} result(s):\n"
                    )
                    for i, r in enumerate(results.results[:top_k], 1):
                        score = getattr(r, "score", 0)
                        text = getattr(r, "text", str(r))[:200]
                        source = getattr(r, "source", "unknown")
    
                        print(
>                           f"  {_colorize(f'[{i}]', 'bold')} Score: {_colorize(f'{score:.3f}', 'cyan')}"
                        )
E                       TypeError: unsupported format string passed to MagicMock.__format__

KBSearchInput = <MagicMock name='mock.KBSearchInput' id='139872579902272'>
_KBSearchInput = <MagicMock name='mock.KBSearchInput' id='139872579902272'>
_tool_kb_search_hybrid = <MagicMock name='mock.tool_kb_search_hybrid' id='139872579910048'>
i          = 1
json       = <module 'json' from '/usr/lib/python3.10/json/__init__.py'>
json_output = False
query      = 'query'
r          = <MagicMock id='139872580023968'>
request    = <MagicMock name='mock.KBSearchInput()' id='139872580072016'>
results    = <MagicMock name='mock.tool_kb_search_hybrid()' id='139872580016192'>
score      = <MagicMock name='mock.score' id='139872580109744'>
source     = <MagicMock name='mock.source' id='139872578133856'>
tenant_id  = 'default'
text       = <MagicMock name='mock.text.__getitem__()' id='139872578126032'>
tool_kb_search_hybrid = <MagicMock name='mock.tool_kb_search_hybrid' id='139872579910048'>
top_k      = 10

cli/src/cortex_cli/main.py:811: TypeError

During handling of the above exception, another exception occurred:

self = <test_main_refactored.TestCliMainUtils object at 0x7f369f704340>
capsys = <_pytest.capture.CaptureFixture object at 0x7f369f704610>

    def test_run_search_success(self, capsys):
        mock_hybrid = MagicMock()
        mock_search_input = MagicMock()
        mock_search_func = MagicMock()
    
        mock_result = MagicMock()
        mock_result.results = [MagicMock(), MagicMock()]
        mock_search_func.return_value = mock_result
    
        mock_hybrid.KBSearchInput = mock_search_input
        mock_hybrid.tool_kb_search_hybrid = mock_search_func
    
        # Patch parent modules to avoid ImportErrors from them
        with patch.dict(
            sys.modules,
            {
                "cortex": MagicMock(),
                "cortex.retrieval": MagicMock(),
                "cortex.retrieval.hybrid_search": mock_hybrid,
            },
        ):
>           _run_search("query", json_output=False)

capsys     = <_pytest.capture.CaptureFixture object at 0x7f369f704610>
mock_hybrid = <MagicMock id='139872579591168'>
mock_result = <MagicMock name='mock.tool_kb_search_hybrid()' id='139872580016192'>
mock_search_func = <MagicMock name='mock.tool_kb_search_hybrid' id='139872579910048'>
mock_search_input = <MagicMock name='mock.KBSearchInput' id='139872579902272'>
self       = <test_main_refactored.TestCliMainUtils object at 0x7f369f704340>

cli/tests/test_main_refactored.py:145: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

query = 'query', top_k = 10, tenant_id = 'default', json_output = False

    def _run_search(
        query: str,
        top_k: int = 10,
        tenant_id: str = "default",
        json_output: bool = False,
    ) -> None:
        """
        Search indexed emails with natural language queries.
        """
        import json
    
        if not json_output:
            _print_banner()
            print(f"{_colorize('▶ SEARCH', 'bold')}\n")
            print(f"  Query:   {_colorize(query, 'cyan')}")
            print(f"  Top K:   {_colorize(str(top_k), 'dim')}")
            print()
    
        try:
            from cortex.retrieval.hybrid_search import (
                KBSearchInput as _KBSearchInput,  # type: ignore[import]
            )
            from cortex.retrieval.hybrid_search import (
                tool_kb_search_hybrid as _tool_kb_search_hybrid,  # type: ignore[import]; type: ignore[reportUnknownVariableType]
            )
    
            _KBSearchInput = cast(Any, _KBSearchInput)
            _tool_kb_search_hybrid = cast(Any, _tool_kb_search_hybrid)
            KBSearchInput: type[Any] = cast(type[Any], _KBSearchInput)
            tool_kb_search_hybrid: Callable[[Any], Any] = cast(
                Callable[[Any], Any], _tool_kb_search_hybrid
            )
    
            request: Any = KBSearchInput(
                tenant_id=tenant_id,
                user_id="cli-user",
                query=query,
                k=top_k,
            )
    
            if not json_output:
                print(f"  {_colorize('⏳', 'yellow')} Searching...\n")
    
            results: Any = tool_kb_search_hybrid(request)
    
            if json_output:
                # Convert results to JSON-serializable format
                output: dict[str, Any] = {
                    "success": True,
                    "query": query,
                    "results": (
                        [r.model_dump() for r in results.results]
                        if hasattr(results, "results")
                        else []
                    ),
                    "total": len(results.results) if hasattr(results, "results") else 0,
                }
                print(json.dumps(output, indent=2, default=str))
            else:
                if hasattr(results, "results") and results.results:
                    print(
                        f"  {_colorize('✓', 'green')} Found {len(results.results)} result(s):\n"
                    )
                    for i, r in enumerate(results.results[:top_k], 1):
                        score = getattr(r, "score", 0)
                        text = getattr(r, "text", str(r))[:200]
                        source = getattr(r, "source", "unknown")
    
                        print(
                            f"  {_colorize(f'[{i}]', 'bold')} Score: {_colorize(f'{score:.3f}', 'cyan')}"
                        )
                        print(f"      Source: {_colorize(str(source), 'dim')}")
                        print(f"      {text}...")
                        print()
                else:
                    print(f"  {_colorize('○', 'yellow')} No results found for: {query}")
                print()
    
        except ImportError as e:
            msg = f"Could not load search module: {e}"
            if json_output:
                print(json.dumps({"error": msg, "success": False}))
            else:
                print(f"\n  {_colorize('ERROR:', 'red')} {msg}")
                print(f"  Make sure you have run {_colorize('cortex index', 'cyan')} first")
            sys.exit(1)
        except Exception as e:
            if json_output:
                print(json.dumps({"error": str(e), "success": False}))
            else:
                print(f"\n  {_colorize('ERROR:', 'red')} {e}")
>           sys.exit(1)
E           SystemExit: 1

KBSearchInput = <MagicMock name='mock.KBSearchInput' id='139872579902272'>
_KBSearchInput = <MagicMock name='mock.KBSearchInput' id='139872579902272'>
_tool_kb_search_hybrid = <MagicMock name='mock.tool_kb_search_hybrid' id='139872579910048'>
i          = 1
json       = <module 'json' from '/usr/lib/python3.10/json/__init__.py'>
json_output = False
query      = 'query'
r          = <MagicMock id='139872580023968'>
request    = <MagicMock name='mock.KBSearchInput()' id='139872580072016'>
results    = <MagicMock name='mock.tool_kb_search_hybrid()' id='139872580016192'>
score      = <MagicMock name='mock.score' id='139872580109744'>
source     = <MagicMock name='mock.source' id='139872578133856'>
tenant_id  = 'default'
text       = <MagicMock name='mock.text.__getitem__()' id='139872578126032'>
tool_kb_search_hybrid = <MagicMock name='mock.tool_kb_search_hybrid' id='139872579910048'>
top_k      = 10

cli/src/cortex_cli/main.py:833: SystemExit
----------------------------- Captured stdout call -----------------------------

╔═══════════════════════════════════════════════════════════╗
║  EmailOps Cortex CLI - Email Intelligence Platform       ║
║  Powered by Vertex AI & LangGraph                          ║
╚═══════════════════════════════════════════════════════════╝

▶ SEARCH

  Query:   query
  Top K:   10

  ⏳ Searching...

  ✓ Found 2 result(s):


  ERROR: unsupported format string passed to MagicMock.__format__
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.10.12-final-0 _______________

Name                                    Stmts   Miss  Cover   Missing
---------------------------------------------------------------------
cli/src/cortex_cli/__init__.py              0      0   100%
cli/src/cortex_cli/_config_helpers.py      33     28    15%   8-17, 22-53, 60-99
cli/src/cortex_cli/cmd_db.py               88     88     0%   9-171
cli/src/cortex_cli/cmd_doctor.py          570    570     0%   22-1160
cli/src/cortex_cli/cmd_embeddings.py       71     71     0%   9-157
cli/src/cortex_cli/cmd_s3.py              111    111     0%   9-197
cli/src/cortex_cli/main.py                668    563    16%   37, 42, 175-177, 182-224, 229-239, 244-324, 333-368, 383-443, 461-645, 659-739, 789-799, 813-818, 821-827, 830, 850-923, 935-966, 977-996, 1001-1020, 1025-1048, 1053-1060, 1065-1071, 1083-1158, 1167-1249, 1254-1458, 1466-1578, 1601-1623, 1629-1768, 1772
cli/src/cortex_cli/style.py                 6      1    83%   22
cli/src/cortex_cli/tui.py                 123    123     0%   5-263
cli/src/cortex_cli/tui_handlers.py        258    258     0%   6-495
---------------------------------------------------------------------
TOTAL                                    1928   1813     6%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
============================= slowest 10 durations =============================
0.01s call     cli/tests/test_main_refactored.py::TestCliMainUtils::test_run_search_success
0.00s setup    cli/tests/test_main_refactored.py::TestCliMainUtils::test_run_search_success
0.00s teardown cli/tests/test_main_refactored.py::TestCliMainUtils::test_run_search_success
=========================== short test summary info ============================
FAILED cli/tests/test_main_refactored.py::TestCliMainUtils::test_run_search_success - SystemExit: 1
======================= 1 failed, 6 deselected in 1.63s ========================

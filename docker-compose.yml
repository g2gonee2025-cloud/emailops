version: "3.9"

services:
  db:
    # Includes the pgvector extension out of the box.
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: cortex
      POSTGRES_USER: cortex
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cortex -d cortex"]
      interval: 10s
      timeout: 5s
      retries: 20
    restart: unless-stopped
    networks:
      - emailops_net

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 20
    restart: unless-stopped
    networks:
      - emailops_net

  embeddings:
    # CPU-friendly option (but the default 12B model is usually GPU-class).
    # If this is too slow or OOMs, see README for GPU/vLLM alternative.
    image: ghcr.io/huggingface/text-embeddings-inference:latest
    command: >-
      --model-id ${EMBED_MODEL:-tencent/KaLM-Embedding-Gemma3-12B-2511}
      --revision ${EMBED_REVISION:-CausalLM}
      --port 80
      --json-output
      --auto-truncate
    environment:
      HF_HUB_ENABLE_HF_TRANSFER: "1"
    volumes:
      - ./data/huggingface:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 40
    restart: unless-stopped
    networks:
      - emailops_net
    # Optional for debugging from your laptop via SSH tunnel:
    # ports:
    #   - "127.0.0.1:8080:80"

  qdrant:
    image: qdrant/qdrant:latest
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
    volumes:
      - qdrantdata:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:6333/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
    restart: unless-stopped
    networks:
      - emailops_net

  app:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file:
      - ./.env
    environment:
      # Ensure the backend calls the colocated embeddings service (low-latency path).
      DO_LLM_BASE_URL: "http://embeddings:80"
      # Canonical env var names expected by the backend.
      OUTLOOKCORTEX_DB_URL: "postgresql://cortex:${POSTGRES_PASSWORD}@db:5432/cortex"
      OUTLOOKCORTEX_REDIS_URL: "redis://redis:6379"
      OUTLOOKCORTEX_QDRANT_URL: "http://qdrant:6333"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      embeddings:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    volumes:
      - ./data:/data
    ports:
      # Expose API publicly on 8000 (lock down via DigitalOcean Cloud Firewall).
      - "0.0.0.0:8000:8000"
    restart: unless-stopped
    networks:
      - emailops_net

volumes:
  pgdata:
  redisdata:
  qdrantdata:

networks:
  emailops_net:
    driver: bridge

apiVersion: apps/v1
kind: Deployment
metadata:
  name: embeddings-api
  namespace: emailops
  labels:
    app: emailops
    component: embeddings
spec:
  # replicas: 1 # Managed by KEDA
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: emailops
      component: embeddings
  template:
    metadata:
      labels:
        app: emailops
        component: embeddings
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
    spec:
      priorityClassName: emailops-high-priority
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
      containers:
        - name: vllm
          image: vllm/vllm-openai:latest
          args:
            - "--model"
            - "tencent/KaLM-Embedding-Gemma3-12B-2511"
            - "--task"
            - "embed"
            # - "--revision"    # Optional: Removed to use default/latest
            # - "CausalLM"      # Optional
            - "--enforce-eager"
            - "--trust-remote-code"
            - "--port"
            - "8000"
            - "--max-model-len"
            - "8192"
            # Correct flag for controlling concurrency/batching
            - "--max-num-seqs"
            - "256"
          env:
            - name: HF_HUB_ENABLE_HF_TRANSFER
              value: "1"
          ports:
            - containerPort: 8000
              name: http
          volumeMounts:
            - mountPath: /dev/shm
              name: dshm
          resources:
            requests:
              memory: "32Gi"
              cpu: "4"
              nvidia.com/gpu: "1"
            limits:
              memory: "40Gi"
              cpu: "8"
              nvidia.com/gpu: "1"
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            failureThreshold: 60
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 20
      tolerations:
        - key: "nvidia.com/gpu"
          operator: "Exists"
          effect: "NoSchedule"
      nodeSelector:
        doks.digitalocean.com/node-pool: pool-gpu-h200
---
apiVersion: v1
kind: Service
metadata:
  name: embeddings-api
  namespace: emailops
  labels:
    app: emailops
    component: embeddings
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    app: emailops
    component: embeddings

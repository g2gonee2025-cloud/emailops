# =============================================================================
# KEDA ScaledObjects for EmailOps GPU Workloads
# =============================================================================
# Reference: https://keda.sh/docs/2.16/scalers/prometheus/
# =============================================================================

---
# ScaledObject for AI Bundle (Embeddings + Reranker)
# Strategy: Scale to 0 when idle. Wake up (0->1) when Backend receives relevant traffic.
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ai-bundle-scaler
  namespace: emailops
spec:
  scaleTargetRef:
    name: ai-bundle

  # Scale to zero when idle
  minReplicaCount: 0
  maxReplicaCount: 1              # Single GPU limit

  # Cooldown: How long to wait after traffic stops before killing the pod
  cooldownPeriod: 600             # 10 minutes
  pollingInterval: 15             # Check metrics every 15s

  fallback:
    failureThreshold: 3
    replicas: 1                   # If Prometheus fails, keep 1 replica safe

  triggers:
    # Trigger: Traffic to Backend Search/Embeddings endpoints
    # Use 'rate' to detect incoming requests.
    # If rate > 0.05 req/s (approx 1 req every 20s), scale up.
    - type: prometheus
      metadata:
        serverAddress: http://prometheus-kube-prometheus-prometheus.kube-prometheus-stack.svc.cluster.local:9090
        # Query matches both /api/v1/search AND /api/v1/embeddings
        query: sum(rate(http_request_duration_seconds_count{handler=~"/api/v1/(search|embeddings).*"}[2m])) or vector(0)
        threshold: "0.05"
        activationThreshold: "0.01"  # Activate strictly on ANY traffic
        ignoreNullValues: "true"

---
# ServiceMonitor for AI Bundle (Scraping vLLM metrics from the pod itself)
# Note: KEDA doesn't use this for activation (since pod is dead), but useful for monitoring when alive.
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: ai-bundle-metrics
  namespace: emailops
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      component: ai-bundle
  endpoints:
    - port: embeddings  # Port 8000
      path: /metrics
      interval: 15s
    - port: reranker    # Port 8001
      path: /metrics
      interval: 15s

---
# ServiceMonitor for Backend (FastAPI)
# Critical: This provides the metrics KEDA uses to wake up the AI Bundle.
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: backend-metrics
  namespace: emailops
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      component: backend
  endpoints:
    - port: http
      path: /metrics
      interval: 15s
